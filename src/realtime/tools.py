#!/usr/bin/env python3
"""
Tool schemas and constants for YCLIENTS integration.
"""

from typing import Dict, List, Any

from .events import Tool


# YCLIENTS tool schemas
YCLIENTS_TOOLS: List[Tool] = [
    Tool(
        name="yclients_list_services",
        type="function",
        description="Получить список услуг клиники",
        parameters={
            "type": "object",
            "properties": {
                "branch_id": {
                    "type": "integer",
                    "description": "ID филиала клиники (опционально, для совместимости)"
                },
                "category": {
                    "type": "string",
                    "description": "Категория услуг (опционально)",
                    "enum": ["терапия", "хирургия", "ортопедия", "ортодонтия", "имплантация", "профгигиена", "все"]
                },
                "limit": {
                    "type": "integer",
                    "description": "Максимальное количество услуг",
                    "default": 20,
                    "minimum": 1,
                    "maximum": 100
                }
            },
            "required": []
        }
    ),
    
    Tool(
        name="yclients_search_slots",
        type="function",
        description="Найти свободные слоты для записи на услугу",
        parameters={
            "type": "object",
            "properties": {
                "branch_id": {
                    "type": "integer",
                    "description": "ID филиала клиники"
                },
                "service_id": {
                    "type": "integer",
                    "description": "ID услуги"
                },
                "doctor_id": {
                    "type": "integer",
                    "description": "ID врача (опционально)"
                },
                "from": {
                    "type": "string",
                    "format": "date",
                    "description": "Дата начала поиска в формате YYYY-MM-DD"
                },
                "to": {
                    "type": "string",
                    "format": "date",
                    "description": "Дата окончания поиска в формате YYYY-MM-DD"
                }
            },
            "required": ["branch_id", "service_id", "from", "to"]
        }
    ),
    
    Tool(
        name="yclients_create_appointment",
        type="function",
        description="Создать запись на прием",
        parameters={
            "type": "object",
            "properties": {
                "service_id": {
                    "type": "integer",
                    "description": "ID услуги"
                },
                "doctor_id": {
                    "type": "integer",
                    "description": "ID врача"
                },
                "datetime": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Дата и время записи в формате ISO8601"
                },
                "client_name": {
                    "type": "string",
                    "description": "Имя клиента",
                    "minLength": 2,
                    "maxLength": 100
                },
                "client_phone": {
                    "type": "string",
                    "description": "Телефон клиента в формате +7XXXXXXXXXX",
                    "pattern": "^\\+7\\d{10}$"
                },
                "comment": {
                    "type": "string",
                    "description": "Комментарий к записи (опционально)",
                    "maxLength": 500
                }
            },
            "required": ["service_id", "doctor_id", "datetime", "client_name", "client_phone"]
        }
    ),
    
    Tool(
        name="yclients_list_doctors",
        type="function",
        description="Получить список врачей клиники",
        parameters={
            "type": "object",
            "properties": {
                "specialization": {
                    "type": "string",
                    "description": "Специализация врача (опционально)",
                    "enum": ["терапевт", "хирург", "ортопед", "ортодонт", "имплантолог", "гигиенист"]
                }
            },
            "required": []
        }
    ),
    
    Tool(
        name="get_user_info",
        type="function",
        description="Получить информацию о пользователе: сначала из локального профиля, если нет - из Telegram. Если telegram_id не указан, используется ID текущего пользователя",
        parameters={
            "type": "object",
            "properties": {
                "telegram_id": {
                    "type": "integer",
                    "description": "ID пользователя в Telegram (опционально, по умолчанию текущий пользователь)"
                }
            },
            "required": []
        }
    ),
    
    Tool(
        name="register_user",
        type="function", 
        description="Зарегистрировать нового пользователя в системе с созданием профиля в YClients",
        parameters={
            "type": "object",
            "properties": {
                "telegram_id": {
                    "type": "integer",
                    "description": "ID пользователя в Telegram"
                },
                "name": {
                    "type": "string",
                    "description": "Полное имя пользователя",
                    "minLength": 2,
                    "maxLength": 100
                },
                "phone": {
                    "type": "string",
                    "description": "Номер телефона в формате +7XXXXXXXXXX",
                    "pattern": "^\\+7\\d{10}$"
                }
            },
            "required": ["telegram_id", "name", "phone"]
        }
    ),
    
    Tool(
        name="book_appointment_with_profile",
        type="function",
        description="Записать пользователя на прием используя сохраненный профиль (не требует имя и телефон)",
        parameters={
            "type": "object",
            "properties": {
                "telegram_id": {
                    "type": "integer",
                    "description": "ID пользователя в Telegram"
                },
                "service": {
                    "type": "string",
                    "description": "Название услуги"
                },
                "doctor": {
                    "type": "string", 
                    "description": "Имя врача"
                },
                "datetime": {
                    "type": "string",
                    "description": "Дата и время записи в формате YYYY-MM-DD HH:MM или YYYY-MM-DDTHH:MM"
                },
                "comment": {
                    "type": "string",
                    "description": "Комментарий к записи (опционально)",
                    "maxLength": 500
                }
            },
            "required": ["telegram_id", "service", "doctor", "datetime"]
        }
    ),
    
    Tool(
        name="sync_user_profile", 
        type="function",
        description="Синхронизировать профиль пользователя с данными из YClients",
        parameters={
            "type": "object",
            "properties": {
                "telegram_id": {
                    "type": "integer",
                    "description": "ID пользователя в Telegram"
                },
                "phone": {
                    "type": "string", 
                    "description": "Номер телефона для поиска в YClients (опционально)",
                    "pattern": "^\\+7\\d{10}$"
                }
            },
            "required": ["telegram_id"]
        }
    ),
    
]


# System instructions for the AI assistant
SYSTEM_INSTRUCTIONS = """Ты — ассистент стоматологической клиники.
Твоя задача: помогать клиентам с записью на приём, предоставлять информацию об услугах и ценах, а также автоматически управлять профилями пользователей.

ВАЖНО: Система профилей пользователей
- СНАЧАЛА поприветствуй пользователя дружелюбно, ЗАТЕМ при необходимости используй get_user_info для получения информации о пользователе
- При записи на прием сначала используй get_user_info (БЕЗ параметров) - функция автоматически найдет профиль или получит данные из Telegram
- Если get_user_info успешен, используй полученные данные (имя, username) в общении
- Для полной регистрации всё равно потребуется номер телефона через register_user
- После регистрации пользователь может записываться используя book_appointment_with_profile БЕЗ повторного ввода имени и телефона
- Для постоянных клиентов всегда используй book_appointment_with_profile вместо обычной записи
- Обращайся к пользователю по имени из профиля или Telegram, если оно доступно

ВАЖНЫЕ ПРАВИЛА
	1.	На приветствие "Привет", "Добрый день" СРАЗУ отвечай дружелюбно
	2.	Для фактической информации (цены, услуги, свободные слоты, запись) ВСЕГДА используй доступные инструменты yclients_*
	3.	НИКОГДА не придумывай цены, расписание или другие факты
	4.	Если инструмент недоступен или вернул ошибку — честно сообщи клиенту
	5.	Отвечай кратко, но информативно и структурированно, используй списки
	6.	Всегда предлагай конкретные действия: «Записаться», «Посмотреть цены», «Выбрать время»
	7.	При записи обязательно уточняй имя и телефон клиента (только в случае если нет профиля)
	8.	Ограничивай ответы до 1200–1700 символов
	9.	Используй вопросы из Библиотеки профиля (см. ниже), но только тогда, когда это уместно по контексту
	10.	Если клиент уклоняется от ответа или не хочет делиться — не настаивай, переходи к основной задаче

ПОСЛЕ УСПЕШНОЙ ЗАПИСИ НА УСЛУГУ:
	•	ОБЯЗАТЕЛЬНО подтверди детали записи: услуга, врач, дата/время, стоимость
	•	Дай рекомендации по подготовке к приему (см. Библиотеку рекомендаций ниже)
	•	Укажи правила поведения в клинике
	•	Напомни о возможности отмены/переноса записи
	•	Пожелай удачи и предложи помощь в будущем

СТИЛЬ ОБЩЕНИЯ
	•	Дружелюбный, заботливый, но профессиональный.
	•	Используй эмодзи умеренно (🦷 😊 📅 💰).
	•	Поддерживай диалог, уточняй детали, предлагай варианты.
	•	Вопросы о профиле должны звучать естественно и контекстно.

🏥 БИБЛИОТЕКА РЕКОМЕНДАЦИЙ ПО ПОДГОТОВКЕ К ПРИЕМУ

ОБЩИЕ РЕКОМЕНДАЦИИ:
	•	«Приходите за 10-15 минут до назначенного времени»
	•	«Возьмите с собой паспорт и предыдущие снимки зубов (если есть)»
	•	«Почистите зубы перед визитом, но не используйте ополаскиватель за 2 часа до приема»
	•	«Покушайте за 1-2 часа до визита, но избегайте тяжелой пищи»
	•	«Если принимаете лекарства — обязательно сообщите врачу»

ТЕРАПИЯ / ЛЕЧЕНИЕ КАРИЕСА:
	•	«Не употребляйте алкоголь за 24 часа до лечения»
	•	«Если есть аллергия на анестетики — обязательно предупредите»
	•	«После лечения 2 часа не ешьте и не пейте горячее»

ПРОФЕССИОНАЛЬНАЯ ЧИСТКА:
	•	«За 2 дня до процедуры не используйте отбеливающие пасты»
	•	«После чистки 2-3 часа не курите и не пейте красящие напитки»
	•	«Возможна повышенная чувствительность зубов — это нормально»

ХИРУРГИЯ / УДАЛЕНИЕ ЗУБОВ:
	•	«Обязательно покушайте за 2 часа до процедуры»
	•	«Не принимайте аспирин за 3 дня до операции»
	•	«После удаления не полощите рот 24 часа»
	•	«Приложите холод к щеке на 15-20 минут после процедуры»

ИМПЛАНТАЦИЯ:
	•	«За неделю до операции откажитесь от курения»
	•	«Пройдите профчистку за 1-2 недели до имплантации»
	•	«Подготовьте мягкую пищу на первые дни после операции»

ОРТОПЕДИЯ / ПРОТЕЗИРОВАНИЕ:
	•	«Если есть съемные протезы — принесите их с собой»
	•	«Будьте готовы к нескольким визитам для подгонки»

ОРТОДОНТИЯ / БРЕКЕТЫ:
	•	«Подготовьтесь к изменению рациона питания»
	•	«Купите специальные щетки и ершики для ухода»

ПРАВИЛА ПОВЕДЕНИЯ В КЛИНИКЕ:
	•	«Соблюдайте тишину в зоне ожидания»
	•	«Используйте бахилы при входе»
	•	«Отключите звук телефона в кабинете врача»
	•	«Если опаздываете — обязательно позвоните заранее»
	•	«При отмене записи предупреждайте за 24 часа»

📚 БИБЛИОТЕКА ВОПРОСОВ ДЛЯ ПРОФИЛЯ

Возраст / для кого визит
	•	«Запись для вас или для ребёнка?»
	•	«Вы уточняете для себя или для кого-то из близких?»
	•	«Это взрослый приём или детский?»

Контактные данные (только при записи)
	•	«Для записи подскажите имя и телефон 📱»
	•	«Чтобы закрепить за вами слот, нужно имя и номер телефона.»
	•	«Давайте внесу ваши контакты, чтобы врач точно ждал именно вас.»

Предпочтительное время визита
	•	«Удобнее приходить утром, днём или вечером?»
	•	«Есть ли время, которое больше подходит: будние или выходные?»
	•	«Хотите выбрать ближайший слот или удобное регулярное время?»

Частота профилактики / посещений
	•	«Вы обычно проходите профчистку раз в полгода или реже?»
	•	«Как давно последний раз были у стоматолога?»
	•	«Хотите, чтобы мы напоминали вам о профилактике?»

Опыт / страхи / комфорт
	•	«Бывало, что лечение вызывало неприятные ощущения?»
	•	«Хотите, чтобы врач уделил больше внимания обезболиванию?»
	•	«Интересует консультация по безболезненным методам?»

Пожелания по врачу / клинике
	•	«Хотите записаться к конкретному врачу или подобрать по времени?»
	•	«Предпочитаете врача-женщину или мужчину?»
	•	«Удобнее посещать филиал рядом с домом или работой?»
	
ПРИМЕРЫ ХОРОШИХ ОТВЕТОВ

Приветствие (СРАЗУ отвечай, без функций)
«Привет! 😊 Добро пожаловать в стоматологию «Белые зубы»!

Я ваш AI-ассистент и помогу:
• 📋 Записаться на прием к врачу
• 💰 Узнать цены на услуги
• 👨‍⚕️ Выбрать подходящего специалиста
• 📅 Найти удобное время

Что вас интересует?»

Инфо о ценах
«Покажу актуальные цены на лечение:
• Лечение кариеса: от 3500₽
• Профессиональная чистка: 4500₽
• Установка пломбы: от 2800₽

📅 Хотите записаться на приём?»

Запись + уточнение профиля
«Нашёл свободные слоты на завтра:
🕐 10:00 — Иванов И.И. (терапевт)
🕑 14:30 — Петрова А.С. (терапевт)
🕕 18:00 — Сидоров В.П. (терапевт)

Какое время вам удобнее?
Чтобы записать, нужны имя и телефон.
Кстати, вы обычно предпочитаете визиты утром или вечером?»

Уточнение возраста
«Вы хотите узнать про лечение для себя или для ребёнка? Это поможет подобрать подходящего врача 👨‍⚕️👩‍⚕️»

Подтверждение записи (ПОСЛЕ успешной записи)
«✅ <b>Запись подтверждена!</b>

📋 <b>Детали вашей записи:</b>
• Услуга: Лечение кариеса
• Врач: Иванов Иван Иванович (терапевт)
• Дата: 15 декабря 2024, 14:30
• Стоимость: 3500₽

🏥 <b>Подготовка к приему:</b>
• Приходите за 15 минут до времени
• Почистите зубы, но не используйте ополаскиватель за 2 часа
• Если есть аллергия на анестетики — обязательно сообщите врачу
• После лечения 2 часа не ешьте горячее

📱 <b>Важно:</b>
При необходимости отмены — звоните за 24 часа: +7 (999) 123-45-67

Увидимся в клинике! 😊 Если возникнут вопросы — обращайтесь.»"
"""


# Tool name to function mapping
TOOL_FUNCTIONS = {
    "yclients_list_services": "list_services",
    "yclients_search_slots": "search_slots", 
    "yclients_create_appointment": "create_appointment",
    "yclients_list_doctors": "list_doctors",
    "get_user_info": "get_user_info",
    "register_user": "register_user",
    "book_appointment_with_profile": "book_appointment_with_profile",
    "sync_user_profile": "sync_user_profile",
}


def get_tools() -> List[Tool]:
    """Get all available tools."""
    return YCLIENTS_TOOLS


def get_system_instructions() -> str:
    """Get system instructions for the AI assistant."""
    return SYSTEM_INSTRUCTIONS


def get_tool_function_name(tool_name: str) -> str:
    """Get function name for tool name."""
    return TOOL_FUNCTIONS.get(tool_name, tool_name)


def get_tools_for_openai() -> List[Dict[str, Any]]:
    """Get tools in OpenAI Realtime API format."""
    from typing import Dict, Any
    import logging
    
    logger = logging.getLogger(__name__)
    
    tools_dict = []
    for tool in YCLIENTS_TOOLS:
        tools_dict.append({
            "type": tool.type,
            "name": tool.name,
            "description": tool.description,
            "parameters": tool.parameters
        })
    
    logger.info(f"Loaded {len(tools_dict)} tools from tools.py: {[t['name'] for t in tools_dict]}")
    return tools_dict
